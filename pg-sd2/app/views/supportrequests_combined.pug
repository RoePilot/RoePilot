extends layout

block content
  if pageTitle
    h1 #{pageTitle}
  else if filterUserName
    h1
      img.profile-img(src="/images/" + filterUserPic, alt=filterUserName)
      |  Support Requests by #{filterUserName}
  else
    h1 Support Requests

  // 🔗 New Support Request Button
  if user
    a.btn(href="/supportrequests/new") + Ask a New Question

  // 🔍 Search Bar
  form#searchForm(method="get", action="/supportrequests")
    input#searchInput(type="text", name="search", placeholder="Search support requests...", value=(search || ""))

  if filterUserName || pageTitle
    a.back-link(href="/supportrequests") ← Back to All Support Requests

  if error
    p.error #{error}
  else if posts && posts.length
    each post in posts
      .post-box
        .post-header
          h2 #{post.Title}
          p.small Posted by User #{post.UserID} on #{post.PostDate}
          if post.CategoryName
            p.small Category: #{post.CategoryName}

        .post-body
          p #{post.Description}

        if post.answers.length
          .answer-section
            h3 Answers
            each answer in post.answers
              .answer-box
                p #{answer.AnswerText}
                p.small Posted on #{answer.PostDate}, Upvotes: #{answer.NumOfUpvote}
                form(action="/answers/upvote/" + answer.AnswerID, method="post")
                  button(type="submit") Upvote
        else
          p.no-comments No answers yet.

        // ✍️ New Answer Form
        if user
          form(method="POST", action="/answers/" + post.RequestID)
            textarea(name="answerText", placeholder="Write your answer..." required)
            button(type="submit") Submit Answer

  else
    p No support requests available.

  // 🔍 Live filtering script
  script.
    function liveFilter(inputId, className) {
      const input = document.getElementById(inputId);
      input.addEventListener("input", () => {
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName(className);
        for (let item of items) {
          const text = item.innerText.toLowerCase();
          if (text.includes(filter)) {
            item.style.display = "";
            const regex = new RegExp(filter, 'gi');
            item.innerHTML = item.innerHTML.replace(/<mark>|<\/mark>/g, '').replace(regex, match => `<mark>${match}</mark>`);
          } else {
            item.style.display = "none";
          }
        }
      });

      input.form.addEventListener("submit", e => {
        e.preventDefault();
      });
    }
    liveFilter("searchInput", "post-box");
